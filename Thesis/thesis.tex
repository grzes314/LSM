\documentclass[a4paper,12pt, twoside]{book}
\usepackage[utf8]{inputenc}
\usepackage{amsmath, amsthm, amssymb}
\usepackage[polish, english]{babel}
\usepackage[OT4]{fontenc}
\usepackage[left=2.5cm,right=2.5cm]{geometry}
\usepackage{fancyhdr}
\usepackage[section]{placeins} %powinno utrzymac obrazki w odpowiednich sekcjach
\usepackage{graphicx}
\usepackage{color}
\usepackage{titlesec}

\addto\captionsenglish{
  \renewcommand\chaptername{Part}}
\titleformat{\chapter}[display]
  {\normalfont\Large\filcenter\sffamily}
  {\titlerule[1pt]%
   \vspace{1pt}%
   \titlerule
   \vspace{1pc}%
   \LARGE\MakeUppercase{\chaptertitlename} \Roman{chapter}
  }
  {1pc}
  {\titlerule
  \vspace{1pc}%
  \Huge}

\setcounter{tocdepth}{1} %subsections won't appear in TOC

\newtheorem{thm}{Theorem}[section]
\newtheorem{prop}[thm]{Proposition}
\newtheorem{coll}[thm]{Colloraly}
\newtheorem{lemma}[thm]{Lemma}

\theoremstyle{definition}
\newtheorem{mydef}{Definition}[section]
\newtheorem{notation}[mydef]{Notation}
\newtheorem{example}{Example}[section]

\theoremstyle{remark}
\newtheorem{remark}{Remark}

% \newcounter{example}
% \newenvironment{example}
%   {\refstepcounter{example} \par\medskip\noindent \textbf{Example~\arabic{example}.}  }
%   {\begin{flushright}$\square$\end{flushright}}
  
\def\Var{{\rm Var}\,}
\def\E{{\mathbb{E}}\,}
\def\P{{\mathbb{P}}\,}
\def\Em{{\mathbb{E}^*}\,}
\def\Pm{{\mathbb{P}}^*\,}
\def\R{{\mathbb{R}}}
\def\conv{\xrightarrow[n \rightarrow \infty]{}}
\def\limn{\lim\limits_{n \rightarrow \infty} }
\def\Sa{\bar{S}}
\def\Xa{\bar{X}}
\def\xia{\bar{\xi}}
%opening
\title{Pricing American and Exotic Options with the Least Squares Monte Carlo Approach}
\author{Grzegorz Łoś}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\small\bfseries\thepage}
\fancyhead[LO]{\small\bfseries\nouppercase\rightmark}
\fancyhead[RE]{\small\bfseries\nouppercase\leftmark}

%\lhead{\nouppercase{\bfseries \leftmark}}
%\rhead{\nouppercase \rightmark}
\setlength{\headheight}{15pt}

\begin{document}
 
\thispagestyle{empty}
\begin{center}
\textbf{\large Uniwersytet Wrocławski\\
Wydział Matematyki i Informatyki\\
Instytut Matematyczny}\\
\textit{\large specjalność: zastosowania}\\
\vspace{4cm}
\textbf{\textit{\large Grzegorz Łoś}\\
\vspace{0.5cm}
{\Large Pricing American and Exotic Options with the Least Squares Monte Carlo Approach}}\\
\end{center}
\vspace{3cm}
{\hspace*{6.5cm}\large Praca magisterska\\
\hspace*{6.5cm}\large  napisana pod kierunkiem\\
\hspace*{6.5cm}\large  doktora Pawła Kawy }
\vfill
\begin{center}
{\large Wrocław 2013}\\
\end{center}

\newpage
\thispagestyle{empty}
\vspace*{10cm}
\noindent {\large Oświadczam, że pracę magisterską wykonałem samodzielnie\\ i~zgłaszam ją do oceny.\\[1.5cm]
Data:....................\hfill Podpis autora pracy:.........................\\[1.5cm]
Oświadczam, że praca jest gotowa do oceny przez recenzenta.\\[1.5cm]
Data:.................... \hfill Podpis opiekuna pracy:.........................}

\newpage

\tableofcontents

\newpage

\section*{\begin{center}\begin{normalsize} Abstract \end{normalsize}\end{center}}
\begin{quotation}
\noindent 
  The thesis presents a technique of option pricing known as Least Squares Monte Carlo or Longstaff-Schwartz model, due to it's discoverers Francis Longstaff and Eduardo Schwartz. In the first chapter some general facts from Stochastic Analysis, Monte Carlo theory and Black-Scholes model are reminded. Next chapters describe LSM algorithm, the implementation, examples of usage for valuation of exotic options.
\end{quotation}

\chapter{Preliminaries}
We expect from the reader some basic knowledge of stochastic processes and option pricing. Purpose of this section is to recall definitions and facts essential for this work and to establish notation.

\section{Elements of stochastic analysis}
\begin{mydef}
 Let $(\Omega, \mathcal{F}, \P)$ be a probability space, $(E, \mathcal{E})$ be a measureable space and $T$ be an arbitrary set. A \textbf{stochastic process} with values in a measurable space $E$, indexed by an arbitrary set $T$, is a family of random variables $X = (X_t)_{t \in T}$, where each $X_t$ is $E$-valued.
 
 For given $\omega \in \Omega$ a \textbf{trajectory} of process $X$ is a function $t \mapsto X_t(\omega)$, with domain $T$ and codomain $E$.
\end{mydef}

\begin{remark}
 Stochastic process may be viewed as a function $X: \Omega \rightarrow \mathbb{E}^T$. Then a trajectory is value of such function, i.e. for given $\omega,\ X(\omega)$ is a trajectory. In the other words, a stochastic process is a random function and a trajectory is it's concrete realization.
\end{remark}

\begin{remark}
 In our applications space $E$ will be equal $\R$ or $\R^n$. 
\end{remark}

\begin{mydef}
 A \textbf{Brownian motion} (or a \textbf{Wiener process}) is a stochastic process $(W_t)_{t \geq 0}$ defined by following conditions:
 \begin{itemize}
  \item $W_0 = 0$ a.s.,
  \item for any $t,\ W_t \sim \mathcal{N}(0,t)$,
  \item increments of $W$ are independent (i.e. for any $t_0 \leq t_1 \leq \ldots \leq t_n$ random variable $W_{t_0}, W_{t_1} - W_{t_0},\ \ldots, W_{t_n} - W_{t_{n-1}}$ are independent,
  \item increments of $W$ are stationary (i.e. for every $0 \leq s < t,\ W_t-W_s$ is equal in distribution to $W_{t-s})$,
  \item trajectories of $W$ are continous a.s.
 \end{itemize}
\end{mydef}
\noindent In this paper $W$ will always denote Brownian motion.

\begin{mydef}
 \textbf{Filtration} $(\mathcal{F}_t)_{t=0}^T$ on probability space $(\Omega, \mathcal{F}, {P})$ is an increasing family of $\sigma$-algebras contained in $\mathcal{F}$, i.e. for all $s<t,\ \mathcal{F}_s \subseteq \mathcal{F}_t \subseteq \mathcal{F}$.
\end{mydef}
\noindent Sometimes $\mathcal{F}_t$ is interpreted as a set of all events observable up to time $t$.

\begin{mydef}
 Process $X=(X_t)_{t=0}^T$ is called $\mathcal{F}_t$-\textbf{adoptable} if and only if for all $t~\in~[0,T],\ X_t$ is $\mathcal{F}_t$-measurable.
\end{mydef}
\noindent Minimal filtration to which $X$ is adoptable if of course filtration generated by $X$, defined as $\mathcal{F}_t^X = \sigma(X_s:\ s \leq t)$.

\begin{mydef}
 A \textbf{stopping time} with respect to filtration $(\mathcal{F}_t)_{t=0}^T$ is a random variable $\tau:\ \Omega \rightarrow [0,T]\cup\{\infty\}$, such that $\{\tau \leq t\} \in \mathcal{F}_t$ for all $t \in [0,T]$.
\end{mydef}
If $X$ is a process corresponding to some risky game, then a stopping time may be seen as a strategy which tells us whether we should withdraw at time $t$, basing only on the information accessible at time $t$.
\begin{example}
 A typical example of a stopping time is first $t$, when $X_t$ reaches a fixed barrier, i.e.
 \[\tau = \inf\{t\in[0,T]: X_t \geq b\}\]
\end{example}
\noindent Stopping times play important role in financial mathematics. Often we are interested in finding an optimal strategy for exercising an option. Such strategy is a stopping time.

\begin{mydef}
 We call a stochastic process $M=(M_t)_{t=0}^T$ a \textbf{martingale} with respect to filtration $(\mathcal{F}_t)_{t=0}^T$ if and only if it satisfies following conditions:
 \begin{itemize}
  \item for all $t \in [0,T],\ M_t$ is $\mathcal{F}_t$-measurable,
  \item $\E|M_t| < \infty$,
  \item for all $0 \leq s < t \leq T, \E[M_t|\mathcal{F}_s] = M_s$  a.s.
 \end{itemize}
\end{mydef}

\begin{example}
 Brownian motion $W$ is a martingale. Indeed, we have
 \begin{equation*}
  \E[W_t|\mathcal{F}_s] = \E[W_t-W_s|\mathcal{F}_s] + \E[W_s|\mathcal{F}_s] = \E[W_t-W_s] + W_s = W_s.
 \end{equation*}
 for all $t > s$.
\end{example}
\begin{example}
 \label{ex:angleWt}
 Process $(W_t^2-t)_t$ is a martingale. As previously, for any $t > s$
 \begin{equation*}
  \begin{split}
       & \E[W_t^2-t|\mathcal{F}_s] = \E[(W_t-W_s)^2 + 2W_tW_s - W_s^2|\mathcal{F}_s] -t =\\ 
    =\ & \E[(W_t-W_s)^2|\mathcal{F}_s] + \E[2W_tW_s|\mathcal{F}_s] - \E[W_s^2|\mathcal{F}_s] -t = \\
    =\ & \E[(W_t-W_s)^2] + 2W_s\E[W_t|\mathcal{F}_s] - W_s^2 -t = \\
    =\ & \E[(W_t-W_s)^2] + 2W_s^2 - W_s^2 -t = W_s^2 - s.
  \end{split}
 \end{equation*}
\end{example}

\noindent Before we move to SDE's and It\^{o}'s lemma, let us do a notation remark. Let $X$ be a square integrable process and $Z$ be a process with respect to which we can integrate ($Z$ may be a Brownian motion, a martingale, or in general even a semimartingale).
\begin{itemize}
 \item $\int\limits_0^t X_s ds$ is a ``standard'' Riemann integral. The integrated function is random, but for fixed $\omega$ we can use Riemann's theory to integrate it.
 \item $\int\limits_0^t X_s dZ_s$ denotes isometric It\^{o} integral.
\end{itemize}

\begin{mydef}
\label{def:SDE}
 Let $\mu, \sigma \in C^1,\ \xi$ be $\mathcal{F}_s$-measurable random variable. We say that process $X=(X_t)_{t=0}^T$ solves a \textbf{stochastic differential equation (SDE)}
 \[dX_t = \mu(X_t)dt + \sigma(X_t) dW_t,\ X_0 = \xi\]
 if and only if
 \[X_t = \xi + \int\limits_0^t \mu(X_s)ds + \int\limits_0^t\sigma(X_s) dW_s\]
for all $t \in [0,T)$.
\end{mydef}

\begin{mydef}
 A stochastic process $S$ given by SDE
 \begin{equation}
  dS_t = \mu S_t dt + \sigma S_t dW_t, 
  \label{eq:gbm}
 \end{equation}
where $\mu,\sigma \in \R$ is called a \textbf{geometic Brownian motion}.
\end{mydef}

\noindent Now we can formulate a version of It\^{o}'s lemma, which is widely used in financial mathematics.
\begin{thm}[It\^{o}'s lemma]
 \label{thm:ito}
  Let $S$ be a geometic Brownian motion as in (\ref{eq:gbm}), $F:\ \R^2 \rightarrow \R,\ F \in C^2$. Then 
  \begin{equation*}
   F(S_t, t) = F(S_0, 0) + \int\limits_0^t \frac{\partial F}{\partial S}(S_r,r)dS_r + \int\limits_0^t \frac{\partial F}{\partial t}(S_r,r)dr + \frac{1}{2}\sigma^2 S_t^2 \int\limits_0^t \frac{\partial^2 F}{\partial S^2}(S_r,r)dr
  \end{equation*}
  or equivalently in SDE form
  \begin{equation}
   \label{eq:ito}
   dF(S_t, t) = \frac{\partial F}{\partial S}(S_t,t)dS_t + \frac{\partial F}{\partial t}(S_t,t)dt + \frac{1}{2}\sigma^2 S_t^2 \frac{\partial^2 F}{\partial S^2}(S_t,t)dt   .
  \end{equation}  
\end{thm}
{\Large \color{red} Wskazac pozycje z dowodem}

\noindent In the books on the stochastic processes It\^{o}'s lemma is proven in much greater generality. However, for our purposes, as in many other literature on financial mathematics, formulated theorem will be sufficient. Equation (\ref{eq:ito}) is also called an It\^{o}'s formula.

Significance in financial mathematics of the next theorem results from a fact, that it allows us to move from real measure $\P$ to equivalent martingale measure $\Pm$.
\begin{thm}[\bfseries Girsanov theorem]
 \label{thm:girsanov}
 Let $\bar{W}$ be a $d$-dimensional standard Wiener process on probability space $(\Omega, \mathcal{F}, (\mathcal{F}_t)_{t=0}^T, \P)$ and let $\varphi$ be any $d$-dimensional adapted column vector process. Choose a fixed $T$ and define the process $L$ on $[0,T]$ by
 \[ L_t = \exp\left\{ \int\limits_0^t \varphi_s \cdot d\bar{W}_s - \frac{1}{2}\int\limits_0^t ||\varphi_s||^2ds. \right\} \]
 Assume that 
 \[ \E^P[L_T] = 1, \]
 and define the new probability measure $\mathbb{Q}$ on $\mathcal{F}_T$ by
 \[ \frac{d\mathbb{Q}}{d\P} = L_T,\ \ \hbox{ on } \mathcal{F}_T. \]
 Then $W$ given by
 \[W_t = \bar{W}_t - \int\limits_0^t \varphi_s ds\]
 is a standard Wiener process under $\mathbb{Q}$.
\end{thm}
\begin{remark}
 Symbol $\cdot$ in definition of $L$ is the inner product of two vectors. 
\end{remark}
The proof of Girsanov theorem reader may find for example in \cite{bjork} (Theorem 11.3).

\section{Elements of Monte Carlo theory}
Monte Carlo methods are a class of algorithms designed for estimation of unknown values by simulation. They do not refer to any particular algorithm, they are rather a general ``recipe'' for procedures, which obtain results by simulation.

\subsection{Crude Monte Carlo}
Suppose we want to estimate an unknown value $I$, which can be written as expected value of some random variable, i.e.
\[ I = \E Y. \]
The idea of Monte Carlo technique is to replicate $Y$ many times, and as estimation of $I$ take an average. So
\[ I \approx \frac{1}{n} \sum\limits_{i=1}^n Y_i, \]
where $n$ is big natural number and $Y_i$ are independent, with the same distribution as $Y$.

This procedure is justified by the strong low of large numbers. Let 
\begin{equation}
 \label{eq:CMC}
 \hat{Y}_n = \frac{1}{n}\sum\limits_{i=1}^n Y_i
\end{equation}
It is called \textbf{crude Monte Carlo} estimator. Of course $\E\hat{Y}_n = \E Y = I$, so $\hat{Y}_n$ is unbiased. Moreover, from law of large numbers $\hat{Y}_n \conv I$ a.s., what implies 
\[ \P(|\hat{Y}_n - I| > b) \conv 0 \hbox{\ \ a.s.,} \]
for any $b > 0$. 

Here appears a natural question, how big should be number $n$ for fixed $b$, so we could tell, that error of our estimation, with known probability $1-\alpha$, is not greater than $b$?
Let $\sigma = \sqrt{\Var{Y}}$, $z_{1-\alpha/2} = \Phi^{-1}(1-\alpha/2)$, where $\Phi$ is cumulative distribution function of normal distribution. Simple calculations give
\begin{align*}
 \P(-b \leq \hat{Y}_n - I \leq b) &= 1 - \alpha\\
 \P(-b \leq \frac{\sum\limits_{i=1}^n Y_i - nI}{n}  \leq b) &= 1 - \alpha\\
 \P(-\frac{b\sqrt{n}}{\sigma} \leq \frac{\sum\limits_{i=1}^n Y_i - nI}{\sqrt{n}\sigma}  \leq \frac{b\sqrt{n}}{\sigma}) &= 1 - \alpha
\end{align*}
From Central Limit Theorem we have
\[ \limn \P(-z_{1-\alpha/2} \leq \frac{\sum\limits_{i=1}^n Y_i - nI}{\sqrt{n}\sigma}  \leq z_{1-\alpha/2}) = 1 - \alpha, \]
hence for large $n$ we have
\[z_{1-\alpha/2} \approx \frac{b\sqrt{n}}{\sigma}.\]
In a typical situation we do not know variation of $Y$ (we don't even know the expected value, yet we are using Monte Carlo method to find it!), so above formula has rather theoretical meaning. However, there is a version of CLT which uses unbiased estimator
\[ \hat{\sigma} = \frac{1}{n-1}\sum\limits_{i=1}^n (Y_i - \hat{Y}_n)^2 \]
instead of $\sigma$, what allows to replace $\sigma$ by $\hat{\sigma}$ in above approximation. We have proven following 
\begin{thm}
 Dependency between number of simulations $n$, error $b$ and confidence level $\alpha$ is given by following formulas
 \begin{equation}
   \label{eq:error}
   b = \frac{\hat{\sigma} z_{1-\alpha/2}}{\sqrt{n}}
 \end{equation}
 \begin{equation}
   \label{eq:sim}
   n = \frac{\hat{\sigma}^2 z_{1-\alpha/2}^2}{b^2}.
 \end{equation}
\end{thm}
\noindent Equation (\ref{eq:error}) tells us how big is an error of estimation when we performed $n$ simulation. Equation (\ref{eq:sim}) inverses situation, it allows us to plan the number of simulations necessary to obtain requested accuracy.

\subsection{Simulation.}
Now, when we know how Monte Carlo methods work, we need to describe how to get random values. Most computational enviroments and programming languages have built-in generator of values from uniform distribution. We will show how to obtain (pseudo)random variables with ubiquitous normal distribution.

The most popular way is to use Box-Muller algorithm
\begin{enumerate}
 \item generate independent random variables $U_1, U_2$ with uniform distribution,
 \item $N_1 := \sqrt{-2\log(U_1)} \cos(2\pi U_2)$,
 \item $N_2 := \sqrt{-2\log(U_1)} \sin(2\pi U_2)$,
 \item return($N_1$, $N_2$).
\end{enumerate}
This method returns values of two independent random variables coming from standard normal distribution. Necessity of calculating sine and cosine may is slowing algorithm down. The second procedure is significantly faster.
\begin{enumerate}
 \item generate independent random variables $U_1, U_2$ with uniform distribution,
 \item $V_1 := 2U_1-1$,
 \item $V_2 := 2U_2-1$,
 \item $W := U_1^2 + U_2^2$,
 \item $N_1 := \sqrt{\frac{-2\log(W)}{W}} V_1$,
 \item $N_2 := \sqrt{\frac{-2\log(W)}{W}} V_2$,
\end{enumerate}

Above methods allows us to generate independent random variables. In the real world however, movements of observed values are often correlated. Following algorithm generetes values from multivariate normal distribution with given mean vector $\mu$ and covariation matrix $\Sigma$. 
\begin{enumerate}
 \item use Cholesky decomposition to obtain matrix $L$ such that $\Sigma = LL^T$,
 \item using previously shown method generate vector $N$ of independent random variables with standard normal distribution.
 \item return $\mu + LN$.
\end{enumerate}
{\Large \color{red} Wskazac pozycje z dowodem}


\chapter{Basics of option pricing}
The main field of interest of the financial mathematics is pricing so-called contingent claims, which are assets whose payoff depends on the stock prices. In case of the European options there exists a straightforward forumula, derived by Black and Scholes in 1973, which gives price of the option. Antother way of pricing is using Monte Carlo simulations. Although the simulations are time-consuming and for that reason less effective than Black-Scholes formula, they are widely used because of the possibility to adjust them to diffrent contingent claims. 

\section{Elements of arbitrage theory}

\subsection{Notation}
Throughout this thesis we assume we are given a probability space $(\Omega, \mathcal{F}, (\mathcal{F}_t)_{t=0}^T, \P)$. Since it is observed by investors, $\P$ is sometimes called a \textbf{real measure}, in opposite to artificial \textbf{risk-neutral measure}, which will be later on. Elements of $\Omega$ are called \textbf{market scenarios}. Furthermore $\sigma$-algebra $\mathcal{F}_t$ may be seen as set of all events observable up to time $t$.

We consider a market with $d+1$ assets, where each asset $S^{(i)} = (S^{(i)}_t)_{t=0}^T$ is modelled as a $\R_+$-valued stochastic process adapted to $(\mathcal{F}_t)_{t=0}^T$. The $0$\textsuperscript{th} asset is the money stored in a locally riskless bank account and is given by 
\[S^{(0)}_t = \exp\left\{ \int\limits_0^t r(t)dt \right\},\]
where $r(t)$ is a short term riskless interest rate at time $t$. In general $r(t)$ may also be a stochastic process, however often we will assume $r(t) \equiv r$ and then $S^{(0)}$ may also be regarded as a bond, paying $e^{rT}$ at time $T$. By $S$ we will denote a $d$-dimensional vector of prices of the risky assets, i.e.
\begin{equation*}
 S_t = (S^{(1)}_t, S^{(2)}_t, \ldots, S^{(d)}_t), \ \ \ 0 \leq t \leq T.
\end{equation*}
We also introduce notation $\Sa$ for a $(d+1)$-dimensional vector of prices of all assets, that is
\begin{equation*}
 \Sa_t = (S^{(0)}_t, S_t) = (S^{(0)}_t, S^{(1)}_t, \ldots, S^{(d)}_t), \ \ \ 0 \leq t \leq T.
\end{equation*}

For convenience we also consider discounted time processes
\[ X^{(i)}_t = \frac{S^{(i)}_t}{S^{(0)}_t}. \]
It allows us to compare asset prices quoted at diffrent times. In similar manner as previously we will use notation $X, \Xa$ for vectors of the discounted prices,
\begin{equation*}
 X_t = (X^{(1)}_t, X^{(2)}_t, \ldots, X^{(d)}_t), \ \ \ 0 \leq t \leq T.
\end{equation*}
\begin{equation*}
 \Xa_t = (X^{(0)}_t, X^{(1)}_t, \ldots, X^{(d)}_t), \ \ \ 0 \leq t \leq T.
\end{equation*}

Next definition gives us a notation to describe the content of \textbf{portfolio}.
\begin{mydef}
A \textbf{dynamic trading strategy} is any $\mathcal{F}_t$-adapted,  $\R^{d+1}$-valued process $\xia = (\xia_t)_{t=0}^T = (\xi^{(0)}_t, \xi_t)_{t=0}^T = (\xi^{(0)}_t, \xi^{(1)}_t, \ldots, \xi^{(d)}_t)_{t=0}^T$.
\end{mydef}
Each $\xi^{(i)}_t$ has an interpretation of the quantity of shares of the $i$\textsuperscript{th} asset held in portfolio at time $t$ (it may be negative, then it corresponds to the short sale). Thus, the notion of the portfolio and the dynamic trading strategy may be equated. The value of the portfolio at time $t$ equals
\[\xia_t \cdot \Sa_t = \sum\limits_{i=0}^d \xi^{(i)}_t S^{(i)}_t,\]
where $\cdot$ is the inner product of two vectors.

Assume that investor's portfolio is worth 101\$ today and a year ago it was worth 100\$. Did the investor really make a profit? If riskless interest rate equals 5\%, then investor would gain more if he put all his capital into bank account. This example shows the necessity of discounting to compare portfolios whose values are quoted at diffrent times.
\begin{mydef}
 The \textbf{discounted value process} $V^{\xi} = (V^{\xi}_t)_{t=0}^T$ associated with a trading strategy $\xia$ is given by 
 \begin{equation*}
  V^{\xi}_t = \xia_t \cdot \Xa_t.
 \end{equation*}
\end{mydef}

\subsection{Arbitrage opportunities}
The value $V^{\xi}_0$ is the initial investment into the portfolio. Following definition introduces portfolios which do not receive cash flows from the ``outside world'' after initialization. They are rearranged in such a way that purchases of new assets must be covered by selling some other assets, so value of the portfolio before and after rearranging stays the same.
\begin{mydef}
 A dynamic trading strategy is called \textbf{self-financing} if and only if for every $0 \leq t \leq T$
 \[ \sum\limits_{i=0}^d d\xi^{(i)}_t (S^{(i)}_t + dS^{(i)}_t) = 0. \]
\end{mydef}
This definition, although being very simple, looks completely incomprehensible at first sight. To convey some intuition let's think that $dt$ is a very small, even infinitesimal, time period. Vector $\xia_t$ describes content of the portfolio at the beginning of the period. After time $dt$ change of the stock prices equals $dS_t$. The portfolio needs a rearrangment -- $d\xia_t$ means changes of quantities of the held assets. Thus $\xia_t \cdot (\Sa_t + d\Sa_t)$ is the total cost of the rearrangment. From the definition it equals 0, what explains the name \textit{self-financing}.

From now on we will consider only those market models that are efficient in the sense that they are arbitrage-free.
\begin{mydef}
 An \textbf{arbitrage opportunity} is a self-financing portfolio $\xia$, such that
 \begin{align*}
  V^{\xi}_0 &= 0\\
  \P(V^{\xi}_T \geq 0) &= 1\\
  \P(V^{\xi}_T > 0 ) &> 0
 \end{align*}
 The market is \textbf{arbitrage-free} if it does not allow for arbitrage opportunities.
\end{mydef}
What does arbitrage opportunity mean in practice? Assume an investor entering the market without any money. He builds his portfolio by short sale of some assets and purchase of other assets for received money. Arbitrage opportunity is a situation when the investor at time $T$ can cover his short positions by sale of assets held long, and with positive probability he has some remaining cash. In the other words, he can make money without exposure to any downside risk. 

Now we are moving to an important concept of martingule measure.
\begin{mydef}
 A probability measure $\Pm$ is a \textbf{martingale measure} if and only if the discounted price process $X$ is a $\Pm$-martingale, i.e. for all  $0 \leq s \leq t \leq T$
 \begin{equation}
  \label{eq:X-martingale}
  \Em[X_t] < \infty \hbox{\ \ and\ \ } \Em[X_t | \mathcal{F}_s] = X_s
 \end{equation}
\end{mydef}

\begin{remark}
 Condition (\ref{eq:X-martingale}) is written for a vector $X$, hence for every $1 \leq i \leq d$
  \begin{equation*}
  \Em[X^{(i)}_t] < \infty \hbox{\ \ and\ \ } \Em[X^{(i)}_t | \mathcal{F}_s] = X^{(i)}_s
 \end{equation*}
\end{remark}

Let us recall that two measures $\P$ and $\Pm$ defined on $\sigma$-algebra $\mathcal{F}$ are equivalent if and only if $\forall A \in \mathcal{F}.\ \P(A)=0 \Leftrightarrow \Pm(A)=0$. Next theorem, known as \textbf{first fundamental theorem of asset pricing}, shows importance of martingale measures.
\begin{thm}[\bfseries First FTAP]
 \label{thm:fftap}
 The following to statements are \emph{essentialy} equivalent:
 \begin{enumerate}
  \item The market model is arbitrage free.
  \item There exists martingale measure $\Pm$ equivalent to $\P$.
 \end{enumerate}
\end{thm}
Unfortunatly, due to an appearence of a word ``essentialy'', this is rather a ``meta-theorem''. It can be given a sharp, mathematical sense -- see for example Theorems 10.9 and 10.10 in \cite{bjork}. In the discrete case, however, theorem holds without the word ``essentialy'', as it is proven in \cite{follmer} (Theorem 5.17). This case is sufficient for us, since trajectories can be simulated only in a finite number of points.

\section{European contingent claims}
We start this section with definition of a mentioned contingent claim.
\begin{mydef}
 \label{def:cc_eu}
 \textbf{European contingent claim} is a non-negative random variable $C$ on $(\Omega, \mathcal{F}_T, \P)$. \textbf{Derivative} of underlying assets $S^{(0)}, S^{(1)}, \ldots, S^{(d)}$ is a contingent claim which is measurable with respect to $\sigma$-algebra generated by price processes.
\end{mydef}
European contingent claims may be seen as assets yielding a random payoff at \textbf{exercise date} $T$ (also called \textbf{maturity}). Of course the seller of such contingent claim can't take a random amount of money from the buyer. What should be then the price at time $0$? The answer to this question is definitely nontrivial. However, for some simple derivatives, e.g. European options, there exists a straightforward formula for the price.

\begin{mydef}
 An \textbf{European call option} on asset $S^{(i)}$ with exercise date $T$ and \textbf{strike price} $K$ gives it's owner the right, but not the obligation, to \underline{buy} that asset at time $T$ for a fixed price $K$.
 
 An \textbf{European put option} on asset $S^{(i)}$ with exercise date $T$ and \textbf{strike price} $K$ gives it's owner the right, but not the obligation, to \underline{sell} that asset at time $T$ for a fixed price $K$.
\end{mydef}
From the definition
\begin{equation}
 \label{eq:ecall}
 C\textsuperscript{call} = (S^{(i)}_T - K)_+
\end{equation}
\begin{equation}
 \label{eq:eput}
 C\textsuperscript{put} = (K - S^{(i)}_T )_+
\end{equation}
where $(x)_+ = \max(0,x)$.

A popular modification of above \textbf{vanilla options} are \textbf{barrier options}. Their payoff depends not only on the stock price at maturity, but also on historical prices. Barrier options are divided into \textit{knock-in} options, which may be ``turned on'', and \textit{knock-out} options, which may be ``turned off'' in case of reaching some \textbf{barrier}. Let us write down two example definitions
\begin{mydef}
Payoff of \textbf{up-and-in call} option on asset $S^{(i)}$ with exercise date $T$, strike price $K$ and barrier $\bar{B}$, is
\[ C^{\hbox{\scriptsize call}}_{\hbox{\scriptsize u\&i}} = 
\begin{cases}
 (S^{(i)}_T - K)_+    & \hbox{if } \sup\limits_{0 \leq t \leq T} S^{(i)}_t \geq \bar{B}\\
 0                    & \hbox{otherwise.}
\end{cases}
\]
\end{mydef}
Payoff of knock-out option is zeroed when barrier is reached.
\begin{mydef}
Payoff of \textbf{down-and-out put} option on asset $S^{(i)}$ with exercise date $T$, strike price $K$ and barrier $\underline{B}$, is
\[ C^{\hbox{\scriptsize put}}_{\hbox{\scriptsize d\&o}} = 
\begin{cases}
 (K - S^{(i)}_T)_+    & \hbox{if } \inf\limits_{0 \leq t \leq T} S^{(i)}_t \leq \underline{B}\\
 0                    & \hbox{otherwise.}
\end{cases}
\]
\end{mydef}
We have eight types of barrier options, as every one is call or put, up or down, in or out. They are all defined in similar manner. The best way to get a grip on barrier options is possibly through a graphical example. Figure \ref{fig:barrier} discusses payoff from an up-and-out call option in three diffrent scenarios. 
\begin{figure}[!ht]
\centering
 \includegraphics[scale=0.3]{images/barrier.pdf}
\caption{We consider up-and-out call option with strike 110, barrier 140, expiring at time 1. In the red scenario option is in-the-money at the maturity, however in the past barrier was crossed, thus payoff is 0. In the blue scenario stock price ends about the level of 115, barrier wasn't reached, hence our payoff equals 5. In case of green scenario payoff is 0, as it would be for vanilla option, because we ended out-of-the-money }
\label{fig:barrier}
\end{figure}

\section{Black-Scholes model}
In this section we recall famous Black-Scholes model, leading to a straightforward formula for the price of the European options. Here we are considering a market with only one stock $S$ and a bond $B$. The assumptions of that model are following.

\noindent \textbf{The underlying stock price follows a lognormal model.} Moreover drift $\mu$ and volatility $\sigma$ are constant in time. Thus, SDE for option price is described by equation
\begin{equation}
 \label{eq:stockDynamics}
 dS_t = \mu S_t dt + \sigma S_t dW_t. 
\end{equation}

\noindent \textbf{There exists constant risk-free interest rate $r$.} In the other words, dynamics of $B$ is given by 
\[ dB_t = rB_t dt. \]
Investors may both, borrow and lend, any amount of cash at rate $r$.

\noindent \textbf{It is possible to buy and sell any amount of stock.} It means that investors can even trade fractional numbers of stock, and short sell unbounded quantity of shares.

\noindent \textbf{All transactions do not incur any additional costs.}

\noindent \textbf{The market does not admit arbitrage opportunities.}

Suppose we are constructing a portfolio consisting of short position in one option and long position in $\Delta$ shares. 
Let $\Pi$ be the process of value of portfolio ($\Pi_t$ is value at time $t$), and $V$ be the process of price of the option ($V_t$ is price at time $t$). We have to make one more assumption. 

For some smooth function $V$ \textbf{the price process has the form:}
\[ V_t = V(S_t, t). \]
Note that symbol $V$ has an ambigous meaning -- in above formula left $V$ is price process and the right one is smooth function. However, as in many other literature, we do not bring in additional notation, since it does not lead to misunderstanding.

Many authors forget to mention this last assumption, altough it is very important. Without it we could not use It\^{o}'s lemma.

Equation of portfolio is given by
\begin{equation}
 \label{eq:portfolio}
  \Pi = \Delta S - V 
\end{equation}
We may ask how much the portfolio will change in a short period of time. We have
\[ d\Pi = \Delta dS - dV  \]
Note that we do not have to differentiate $\Delta$, because it does not change in an infinitesimal increment of time. To handle $dV$ we will use It\^{o}s lemma. Thus
\[ d\Pi = \Delta dS - \frac{\partial V}{\partial S}dS - \frac{\partial V}{\partial t}dt - \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 V}{\partial S^2}dt  \]
Risk in increment of portfolio is carriered by changes of stock price. By choosing
\begin{equation}
 \label{eq:delta}
 \Delta = \frac{\partial V}{\partial S}
\end{equation}
we get rid off uncertainity. Now we have
\begin{equation}
  \label{eq:portfolio_inc}
 d\Pi = -(\frac{\partial V}{\partial t} + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 V}{\partial S^2})dt.
\end{equation}
Increment of $\Pi$ does not depend on any risky asset, hence no-arbitrage assumption induces
\[ d\Pi = r\Pi dt. \]
After substituting (\ref{eq:portfolio}), (\ref{eq:delta}) and (\ref{eq:portfolio_inc}) into above equation, we obtain
\[ -(\frac{\partial V}{\partial t} + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 V}{\partial S^2})dt = r(\frac{\partial V}{\partial S} S - V)dt, \]
which after simple calculation gives
\begin{equation}
 \label{eq:BSeq}
 \frac{\partial V}{\partial t} + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 V}{\partial S^2} + r\frac{\partial V}{\partial S} S - rV = 0.
\end{equation}
(\ref{eq:BSeq}) is known as \textbf{Black-Scholes equation}. Note that so far we did not say anything about the final condition of (\ref{eq:BSeq}), i.e. about the payoff off the option, thus this is a general equation. For European options it has straightforward solution.

\begin{align*}
V_t\textsuperscript{call} &= \Phi[d_1(t)]S_t  - \Phi[d_2(t)]K e^{-r(T-t)},\\
V_t\textsuperscript{put} &= -\Phi[-d_1(t)]S_t + \Phi[-d_2(t)]K e^{-r(T-t)},
\end{align*}
where
\begin{align*}
d_1(t) &= \frac{\ln\left(\frac{S_t}{K}\right)+\left(r+\frac{\sigma^{2}}{2}\right)(T-t)}{\sigma\sqrt{T-t}}\\
d_2(t) &= \frac{\ln\left(\frac{S_t}{K}\right)+\left(r-\frac{\sigma^{2}}{2}\right)(T-t)}{\sigma\sqrt{T-t}} = d_{1}(t)-\sigma\sqrt{T-t},\\
\Phi & \hbox{ is distibution function of standard normal distribution. } 
\end{align*}

{\Large \color{red} Wskazac pozycje z dowodem}
It is called \textbf{Black-Scholes formula}.

\section{Risk-neutral pricing}
Black-Scholes formula allows us to price only European vanilla options. In this section we present a general method of pricing European contingent claims. 
\begin{mydef}
 The discounted value of the contingent claim $C$ is given by
 \begin{equation*}
  H = \frac{C}{S^{(0)}_T}.
 \end{equation*}
 Random variable $H$ is called a \textbf{discounted claim}.
\end{mydef}

Values $C$ and $H$ correspond to the payoff of an instrument. We need notation to talk about its price.
\begin{notation}
 The (discounted) \textbf{price process} is denoted by $V_t$. 
\end{notation}
\begin{remark}
 In section \textit{Black-Scholes model} value $V_t$ denoted price of the option at time $t$ (no discounting). From now on $V_t$ is price of the contingent claim at time $t$ discounted to time~$0$.
\end{remark}

Next theorem is the key to defining prices of contingent claims. But first we define a class of claims for which pricing is pretty straightforward. 
\begin{mydef}
 A contingent claim is called \textbf{attainable} if there exists a self-financing trading strategy $\xia$ whose portfolio coincides with $C$ at maturity, i.e.
 \[ C = \xia \cdot \Sa_T. \]
 Trading strategy $\xia$ is then called \textbf{replicating strategy} for $C$.
\end{mydef}

\begin{thm}
 For every attainable discounted claim $H$ and for every equivalent martingale measure $\Pm$
 \[ \Em [H] < \infty. \]
 Moreover, for every replicating strategy $\xia$ its value process satisfies
 \begin{equation}
  V^\xi_t = \Em[H | \mathcal{F}_t] \hbox{ P-a.s., } 0 \leq t \leq T .
 \end{equation}
\end{thm}
Since there is no $\xia$ in term $\Em[H | \mathcal{F}_t]$, so value $V^\xi_t$ does not depend on choice of $\xia$. Note also that
\begin{equation*}
 \Em[H | \mathcal{F}_t]  = \Em[\xia \cdot \Xa_T | \mathcal{F}_t]  = \xia \cdot \Xa_t
\end{equation*}
Thus, value $\Em[H | \mathcal{F}_t]$ does not depend on choice of $\Pm$. 
Since attainable discounted claim $H$ and its replicating strategy $\xia$ have the same payoff at time $T$, thus no-arbitrage assumption induces
\[ V_t = V^\xi_t,\ \ 0 \leq t \leq T. \]
In particular
\[ V_0 = V^\xi_0 = \Em[H].\] 

The above theorem suggests how price processes should look in general.
\begin{mydef}
 The (discounted) price process of the discounted claim $H$ is given by
 \begin{equation*}
  V_t := \Em[H | \mathcal{F}_t].
 \end{equation*}
 Such $V$ is a $\Pm$-martingale.
\end{mydef}
For general claims process $V$ depends on choice of equivalent martingale measure. However, it may be proven that the market model consisting of following discounted assets $(X^{(0)}, X^{(0)},\ldots,X^{(d)}, V)$ is arbitrage-free, regardless of the choice of $\Pm$. In that sense every possible price process $V$ is equally good.

\subsection{Change of the measure}
We have discussed how equivalent martingale measures can be used for option pricing, but so far we did not tell how to find them. For this purpose Girsanov theorem is very usefull.

\begin{prop}
\label{prop:measure_change}
 Suppose that all risky assets on the market follow the geometric Brownian motion, that is for $i=1,2,\ldots,d$
 \begin{equation}
  \label{eq:dynamics_real}
  dS^{(i)} = \mu_i S^{(i)} dt + \sigma_i S^{(i)} d\bar{W}^{(i)},
 \end{equation}
 where each $\bar{W}^{(i)}$ is a Brownian motion under measure $\P$ and $corr(\bar{W}^{(i)}, \bar{W}^{(j)}) = \rho_{ij}$. For every vector $(\nu_1, \nu_2, \ldots, \nu_d)$ there exists equivalent probability measure $\mathbb{Q}$, such that the equation (\ref{eq:dynamics_real}) may be rewritten in the form
  \begin{equation}
  dS^{(i)} = \nu_i S^{(i)} dt + \sigma_i S^{(i)} dW^{(i)},
 \end{equation}
 where each $W^{(i)}$ is a Brownian motion under equivalent measure $Q$ and\\ $corr^Q(W^{(i)}, W^{(j)}) = \rho_{ij}$.
\end{prop}

\begin{proof}
 Let $\Sigma = (\rho_{ij})_{i,j=1}^d$ be a correlation matrix. Cholesky's algorithm allows us to decompose $\Sigma$ to the form
 \[ \Sigma = LL^T. \]
 Hence, $\bar{W}$ may be written in the form
 \[ \bar{W} = L \bar{V}, \]
 where $\bar{V}$ is a standard $d$-dimensional Wiener process under measure $\P$. Let us apply Theorem \ref{thm:girsanov} (Girsanov theorem) with $\varphi = (\theta_1, \theta_2, \ldots, \theta_d)'$, where all $\theta_i$ are constant. It implies that
 \[ V_t = \bar{V}_t - t\theta_i \]
 is $d$-dimensional standard Wiener process under measure $\mathbb{Q}$. Thus
 \begin{equation*}
  \begin{split}
   dS^{(i)} &= \mu_i S^{(i)} dt + \sigma_i S^{(i)} d\bar{W}^{(i)} \\
            &= \mu_i S^{(i)} dt + \sigma_i S^{(i)} d\left(\sum\limits_{k=1}^d l_{ik} \bar{V}^{(k)}\right) \\
            &= \mu_i S^{(i)} dt + \sigma_i S^{(i)} \left(\sum\limits_{k=1}^d l_{ik}\theta_i dt + l_{ik}d V^{(k)}\right) \\    
            &= \left(\mu_i + \sigma_i \theta_i \sum\limits_{k=1}^d l_{ik} \right) S^{(i)} dt + \sigma_i S^{(i)} d\left(\sum\limits_{k=1}^d l_{ik} V^{(k)}\right) \\    
  \end{split}
 \end{equation*}
 By substituting
 \begin{align*}
  \theta_i &:= (\nu_i - \mu_i)/(\sigma_i \sum\limits_{k=1}^d l_{ik})\\
  W &:= LV
 \end{align*}
 we get the thesis.
\end{proof}

Above propostion allows us to describe vector of price processes in terms of some equivalent measures, however we need a very particular measure -- martingale measure.
\begin{lemma}
 Let $S$ be a geometric Brownian motion, i.e.
 \[ dS = \mu S dt + \sigma S dW. \]
 Solution of above SDE is given by
 \begin{equation}
  \label{eq:gmb_sol}
  S = S_0 \exp\left\{ (\mu - \frac{1}{2}\sigma^2)t + \sigma W_t \right\}
 \end{equation}
\end{lemma}
\begin{proof}
We will apply Theorem \ref{thm:ito} (It\^{o}'s formula) with $F(S,t) = \ln(S)$. We have
 \begin{equation*}
  \begin{split}
   dF &= \frac{\partial F}{\partial S}dS + \frac{\partial F}{\partial t}dt + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 F}{\partial S^2}dt \\
   &= \frac{\partial F}{\partial S}(\mu S dt + \sigma S dW) + \frac{\partial F}{\partial t}dt + \frac{1}{2}\sigma^2 S^2 \frac{\partial^2 F}{\partial S^2}dt \\    
   &= \frac{1}{S}(\mu S dt + \sigma S dW) + 0dt - \frac{1}{2}\sigma^2 S^2 \frac{1}{S^2}dt \\   
   &= (\mu - \frac{1}{2}\sigma^2) dt + \sigma dW
  \end{split}.
 \end{equation*}
 From Definition \ref{def:SDE}
 \begin{equation*}
  \begin{split}
  F(S_t,t) &= F_0 + \int\limits_0^t (\mu - \frac{1}{2}\sigma^2) ds + \int\limits_0^t \sigma dW_s\\
  &= F_0 + (\mu - \frac{1}{2}\sigma^2)t + \int\limits_0^t \sigma W_t. 
  \end{split}.
 \end{equation*}
 If we let $S_0 = e^{F_0}$ then
 \[ S = S_0 \exp\left\{ (\mu - \frac{1}{2}\sigma^2)t + \sigma W_t \right\}. \] 
\end{proof}

\begin{coll}
 In real measure $\P$ the risky assets follow a geometric Brownian motion, as in equation (\ref{eq:dynamics_real}). Under equivalent martingale measure $\Pm$ the dynamics has the form
 \begin{equation}
  \label{eq:dynamics_neutral}
  dS^{(i)} = r S^{(i)} dt + \sigma_i S^{(i)} dW^{(i)}.
 \end{equation}
\end{coll}
\begin{proof}
 Proposition \ref{prop:measure_change} states that there exist equivalent measure $\Pm$ under which price processes are described by equation (\ref{eq:dynamics_neutral}). We will show that it is martingale measure.
 From (\ref{eq:gmb_sol})
 \[ X_t = e^{-rt} S_t = S_0 e^{ \frac{1}{2}\sigma^2 t + \sigma W_t }. \]
 Let $0 \leq s \leq t \leq T$. We have
 \begin{equation*}
  \begin{split}
   \Em[X_t | \mathcal{F}_s] &= \Em[ S_0 e^{ \frac{1}{2}\sigma^2 t + \sigma W_t } | \mathcal{F}_s] \\
       &= S_0 e^{\frac{1}{2}\sigma^2 t} \Em[ e^{  \sigma W_s} e^{ \sigma (W_t - W_s) } | \mathcal{F}_s] \\
       &= S_0 e^{\frac{1}{2}\sigma^2 t + \sigma W_s} \Em[ e^{ \sigma (W_t - W_s) }] \\
       &= S_0 e^{\frac{1}{2}\sigma^2 t + \sigma W_s}  e^{ -\frac{1}{2}\sigma^2(t-s) } \\
       &= S_0 e^{\frac{1}{2}\sigma^2 s + \sigma W_s}.
  \end{split}
 \end{equation*}
Hence $\Pm$ is an equivalent martingale measure.
\end{proof}



\section[{Pricing European options with Monte Carlo method}]{Pricing European options with \\Monte Carlo method}
\begin{figure}
\centering
 \includegraphics[scale=0.5]{images/trajectories.pdf}
\caption{Generated trajectories}
\end{figure}


\chapter{Least Squares Monte Carlo}
\section{The idea of LSM}
\begin{figure}[h]
\centering
 \includegraphics[scale=0.5]{images/LSMidea1.pdf}
\caption{To co chcemy}
\end{figure}
\begin{figure}
\centering
 \includegraphics[scale=0.5]{images/LSMidea2.pdf}
\caption{To co mozemy}
\end{figure}

\begin{thebibliography}{99}
\addcontentsline{toc}{section}{\bfseries References}

\bibitem{bjork}
T. Bj\"{o}rk, \emph{Arbitrage Theory in Continuous Time}, Oxford University Press,  New York, 3rd edition, 2009

\bibitem{follmer}
H. F\"{o}llmer, A. Schied, \emph{Stochastic finance. An introduction in discrete time}, Walter de Gruyter, Berlin, 2nd edition, 2004

\bibitem{latala}
R. Latała, \emph{Wstęp do Analizy Stochastycznej}, Warszawa, 2011

\bibitem{london}
J. London, \emph{Modeling derivatives in C++}, John Wiley \& Sons, Hoboken, 2005

\bibitem{l-sch}
F. Longstaff, E. Schwartz, \emph{Valuing American Options by Simulation: A Simple Least Swuares Approach}, The Review of Financial Studies, Vol.14, No.1, pp.113-147, 2001

\bibitem{wilmott}
P. Wilmott, \emph{On quantitative finance}, John Wiley \& Sons, Chichester, 2nd edition, 2006

\end{thebibliography}


\end{document}
